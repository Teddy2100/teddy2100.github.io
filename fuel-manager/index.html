<!doctype html>
<html lang="en" data-framework="polymer">
<head>
 <meta charset="utf-8">
 <title>Fuel Manager</title>
 <meta name="language" content="english"/>
 <meta name="theme-color" content="#E00421">
 <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
 <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
 <script type="text/javascript" src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
 <script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
 <script type="text/javascript" src="./elements/jquery-cookie.min.js"></script>
 <script type="text/javascript" src="./elements/hmac-sha1.min.js"></script>
 <link rel="import" href="../bower_components/vulcanized-full.html"/>
 <link rel="import" href="./elements/event-listener.html"/>
 <link rel="import" href="./app-setup.html"/>
</head>
<body unresolved>
<event-listener id="fuel-gui">
 <paper-drawer-panel id="page" responsive-width="800px">
  <paper-card id="drawer" elevation="0" heading="Fuel Manager" image="./images/header.png" fadeImage drawer>
   <paper-menu class="list" style="padding:0px;">
    <paper-item goto="view-overview"><iron-icon icon="assessment"></iron-icon>View Your Usage</paper-item>
    <paper-item goto="add-reading"><iron-icon icon="social:whatshot"></iron-icon>Add Reading</paper-item>
    <paper-item goto="add-credit"><iron-icon icon="add-shopping-cart"></iron-icon>Add Credit</paper-item>
   </paper-menu>
   <paper-menu class="list stretch" style="padding:0px;display:none;">
    <paper-item goto="logout"><iron-icon icon="exit-to-app"></iron-icon>Logout</paper-item>
   </paper-menu>   
  </paper-card>
  <paper-header-panel id="main" mode="standard" main>
   <paper-toolbar id="title">
    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
    <span class="title" style="display:block;">Fuel Manager</span>
    <paper-icon-button id="actionButton"></paper-icon-button>
   </paper-toolbar>
   <paper-toolbar id="tabs">
    <paper-tabs class="fit" selected="0">
     <paper-tab goto="view-overview">Overview</paper-tab>
     <paper-tab goto="view-electric">Electric</paper-tab>
     <paper-tab goto="view-gas">Gas</paper-tab>
    </paper-tabs>
    <div id="dropShadow" class="style-scope paper-header-panel has-shadow"></div>
   </paper-toolbar>
   <neon-animated-pages selected="0" class="fit">
    <neon-animatable page="view-overview" icon="cached">
     <paper-card heading="Calculating" image="./images/electric.png" size="half"></paper-card>
     <paper-card heading="Calculating" image="./images/gas.png" size="half"></paper-card>
     <paper-card heading="Average Daily Cost"><div class="content"></div></paper-card>
    </neon-animatable>    
    <neon-animatable page="view-electric" icon="cached">
     <paper-card heading="Loading" image="./images/electric.png"><div class="content"></div></paper-card>
    </neon-animatable>
    <neon-animatable page="view-gas" icon="cached">
     <paper-card heading="Loading" image="./images/gas.png"><div class="content"></div></paper-card>
    </neon-animatable>    
    
    <neon-animatable page="add-reading" icon="save">
     <input type="hidden" name="action" value="READING"/>
     <paper-card heading="Add Electric Reading" image="./images/electric.png" size="half"><div class="content">
      <paper-input type="number" name="electric" placeholder="0.00" no-label-float><div prefix>&nbsp;£</div></paper-input>
     </div></paper-card>
     <paper-card heading="Add Gas Reading" image="./images/gas.png" size="half"><div class="content">
      <paper-input type="number" name="gas" placeholder="0.00" no-label-float><div prefix>&nbsp;£</div></paper-input>
     </div></paper-card>
    </neon-animatable>
    
    <neon-animatable page="add-credit" icon="save">
     <input type="hidden" name="action" value="CREDIT"/>
     <paper-card heading="Add Electric Credit" image="./images/electric.png" size="half"><div class="content">
      <paper-input type="number" name="electric" placeholder="0.00" no-label-float><div prefix>&nbsp;£</div></paper-input>
     </div></paper-card>
     <paper-card heading="Add Gas Credit" image="./images/gas.png" size="half"><div class="content">
      <paper-input type="number" name="gas" placeholder="0.00" no-label-float><div prefix>&nbsp;£</div></paper-input>
     </div></paper-card>
    </neon-animatable>    
   </neon-animated-pages>
  </paper-header-panel>
 </paper-drawer-panel>
 <paper-dialog id="connect" entry-animation="scale-up-animation" exit-animation="fade-out-animation" modal>
  <paper-input name="message" type="username" placeholder="username" no-label-float></paper-input>
  <paper-input name="secret" type="password" placeholder="password" no-label-float></paper-input>
  <div class="buttons"><paper-button>Login</paper-button></div>
 </paper-dialog>
</event-listener>
<script type="text/javascript">
var data=[],rows=[],records=25;
$(window).on("load",function(){var cs={expires:28};
 $("paper-card#drawer div#placeholder").removeAttr("hidden");
 $("paper-card#drawer div#placeholder").html($("<div id='tabs-end'>&nbsp;</div>"));
 $("paper-card#drawer div#placeholder").append($("<div id='toolbar-end'>&nbsp;</div>"));
 $("paper-button","paper-dialog#connect").on("click",function(){
  var secret=$("*[name='secret']").get(0).value.toString().toUpperCase();
  var username=$("*[name='message']").get(0).value.toString().toUpperCase();  
  $.cookie("token",CryptoJS.HmacSHA1(username,secret).toString().toUpperCase(),cs);
  $.cookie("username",username,cs);$(window).trigger("connect","retry");
 });$("paper-item[goto='view-overview']").click();
 $(window).trigger("connect","auto");
});

$(window).on("connect",function(e,extra){
 var send={token:$.cookie("token"),username:$.cookie("username")};
 if(send && extra && typeof extra=="object"){send=$.extend(send,extra);}
 if(!send.token&&!send.username){$("paper-dialog#connect").get(0).open();return;}
 $.ajax({data:$.param(send),dataType:"jsonp",timeout:2000,crossDomain:true,async:false,
  beforeSend:function(){$("paper-button","paper-dialog#connect").attr("disabled","disabled");},
  complete:function(){$("paper-button","paper-dialog#connect").removeAttr("disabled");},
  success:function(responce){$(window).trigger(responce.action,responce);}
 });
});

$(window).on("logout",function(e,results){
 $("paper-item").eq(0).click();$("paper-menu").eq(1).hide();
 $.each($.cookie(),function(k,v){$.cookie(k,"");});
 if(results && results.msg){alert(results.msg);}
 if(results){$(window).trigger("connect");}
 else{location.reload();}
});

$(window).on("update",function(e,obj){try{
 if(obj!=null){data=$(obj.data).get();rows=[];}
 $("neon-animatable[page='view-overview']").each(function(e,holder){
  var options={chartArea:{width:'100%',height:'100%',top:0},curveType:'function'};
  if(data.length<3){$("paper-card",holder).attr("heading","Not Enough Readings");return;}  
  var hoursPast=function(s,f){return Number(((new Date(f)-new Date(s))/1000)/3600).toFixed(1);};
   options=$.extend(options,{vAxis:{format:'£#'},hAxis:{format:'DD/MM'},backgroundColor:'transparent',colors:['orange','blue'],legend:'none'});
  var chart=$("<google-chart>").attr("type","line").attr("options",JSON.stringify(options)).width("100%");while(rows.length>records){rows.shift();}//CUT DATA
  var cols=[{label:'Date',type:'string'},{label:'Gas £',type:'number'},{type:'string',role:'tooltip'},{label:'Electric £',type:'number'},{type:'string',role:'tooltip'}];
  $.each(data,function(k){if(data[k-1]){var curr=data[k],last=data[k-1],gas=((last[2]-curr[2])/hoursPast(last[0],curr[0])*24),electric=((last[3]-curr[3])/hoursPast(last[0],curr[0])*24);   
   if(electric>0){$("paper-card[image*='electric'] div.title-text",holder).html("<center>Average Weekly Electric Usage</center><strong>£"+(electric*7).toFixed(2)+"</strong>");}
   if(gas>0){$("paper-card[image*='gas'] div.title-text",holder).html("<center>Average Weekly Gas Usage</center><strong>£"+(gas*7).toFixed(2)+"</strong>");}
   if(gas>0&&electric>0){rows.push([getDate(curr[0]),gas,"Gas £"+gas.toFixed(2),electric,"Electric £"+electric.toFixed(2)]);}   
  }});//$("paper-card[image] div.title-text",holder).css({top:"0px",left:"0px",right:"0px",bottom:"0px",padding:"5px"});
  chart.attr("cols",JSON.stringify(cols)).attr("rows",JSON.stringify(rows)).height("200px");
  $("paper-card[image] div.title-text",holder).addClass("strong");
  $("div.content",holder).last().html(chart);
 });
 
 $("neon-animatable[page='view-electric']").each(function(e,holder){
  $.each(data,function(k,record){if(data[k-1]&&record[1]=="READING"){$("div.content",holder).prepend($("<div>").html(getDate(record[0],true)+" - £"+getPrice(record[3])));}});
  $("paper-card div.title-text",holder).html("<strong>"+Number($(data).last().get(0)[3]/$(rows).last().get(0)[3]).toFixed(1)+" Days</strong>");
  $("paper-card div.title-text",holder).prepend("<center>Estimated Electric Remaining</center>").addClass("strong");
 }); 

 $("neon-animatable[page='view-gas']").each(function(e,holder){
  $.each(data,function(k,record){if(data[k-1]&&record[1]=="READING"){$("div.content",holder).prepend($("<div>").html(getDate(record[0],true)+" - £"+getPrice(record[2])));}});
  $("paper-card div.title-text",holder).html("<strong>"+Number($(data).last().get(0)[2]/$(rows).last().get(0)[1]).toFixed(1)+" Days</strong>");
  $("paper-card div.title-text",holder).prepend("<center>Estimated Gas Remaining</center>").addClass("strong");
 });

 var logout="<paper-item goto='logout'><iron-icon icon='exit-to-app'></iron-icon>Logout ("+obj.username+")</paper-item>";
 $("paper-card[image] div.title-text:has(center)").parent().find("iron-image").css({marginTop:"35px"});
 $("paper-dialog#connect").get(0).close();$("paper-menu").eq(1).html(logout).show();
}catch(error){alert("Update Error:\n"+error.message);}finally{
 $("paper-icon-button#actionButton").removeAttr("disabled");
 $("paper-input","neon-animatable,paper-dialog").val("");  
 $("paper-tab[goto='view-overview']").click();
 console.debug("Updated At: "+new Date());
}});

$("body").on("click","*[goto]",function(e){
 try{var pageHandle=$("neon-animated-pages").get(0),obj=$(this);
  if(obj.attr("goto")=="logout"){$(window).trigger("logout");return;}
  var requestedPage=$("neon-animatable[page='"+obj.attr("goto")+"']").index();
  $("paper-toolbar#tabs,div#tabs-end").css("display",(requestedPage<3)?"block":"none");
   pageHandle.exitAnimation="slide-"+(requestedPage<pageHandle.selected?"right":"left")+"-animation";
   pageHandle.entryAnimation="slide-from-"+(requestedPage<pageHandle.selected?"left":"right")+"-animation";  
  if(this.nodeName=="PAPER-ITEM" && obj.text().length!=0){$("span.title").html(obj.text());}
  $("#actionButton").attr("icon",$("neon-animatable").eq(requestedPage).attr("icon"));
  if(requestedPage!=pageHandle.selected){pageHandle.selected=requestedPage;}  
  if(requestedPage<3){$("paper-tabs").get(0).selected=requestedPage;}
 }catch(error){alert("Navigation Error:\n"+error.message);}
 $("div#mainContainer").animate({scrollTop:0});
});

$("body").on("click","*#actionButton",function(e){var temp={};
 try{var actionHandle=$("neon-animatable.iron-selected[page!='']");
  $("input",actionHandle).map(function(){temp[this.name]=this.value;});
  $.each(temp,function(k,v){if(v==""){throw new Error("Invalid "+k+" value");}});
  if(temp['action']=="CREDIT"){temp['gas']=parseFloat(temp['gas'])+data[data.length-1][2];}
  if(temp['action']=="CREDIT"){temp['electric']=parseFloat(temp['electric'])+data[data.length-1][3];}
  $("#actionButton").attr("disabled","disabled");$(window).trigger("connect",temp);
 }catch(error){alert("Submision Error:\n"+error.message);}
});

$.getScript("./elements/hammer.min.js",function(){
 var setRange=function(v,n,x){return Math.min(Math.max(v,n),x);}
 new Hammer($("neon-animated-pages").get(0)).on("swipe",function(e){
  if(e.direction==2){var swipeTo=$("paper-tab.iron-selected").next().index();}
  if(e.direction==4){var swipeTo=$("paper-tab.iron-selected").prev().index();}
  $("paper-tabs").get(0).selected=setRange(swipeTo,0,2);
  $("paper-tab").get(setRange(swipeTo,0,2)).click();
  $("div#mainContainer").animate({scrollTop:0});
 });console.debug("Gestures: Active");
});
</script>
</body>
</html>
