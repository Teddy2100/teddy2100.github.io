<!doctype html>
<html lang="en" data-framework="polymer">
<head>
 <meta charset="utf-8">
 <title>EE TV GUI</title>
 <meta name="language" content="english"/>
 <meta name="theme-color" content="#009C9C">
 <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
 <link rel="icon" sizes="96x96" href="./images/launcher-icon-96.png">
 <link rel="icon" sizes="192x192" href="./images/launcher-icon-192.png">
 <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
 <script type="text/javascript" src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
 <script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
 <script type="text/javascript" src="./images/jquery.cookie.js"></script>
 <link rel="import" href="../bower_components/vulcanized-full.html"/>
 <link rel="manifest" href="./app-manifest.json"/>
 <link rel="import" href="./app-setup.html"/>
</head>
<body unresolved>
<template is="dom-bind" id="tv-gui">
 <paper-toast-stack></paper-toast-stack> 
 <paper-drawer-panel force-narrow id="page">
  <paper-material id="drawer" elevation="5" drawer>
   <img src="./images/logo.png" alt="Logo" title="Logo"/>
   <paper-menu class="list" style="padding:0px;">
    <paper-item file="remote.html"><iron-icon icon="notification:tap-and-play"></iron-icon>Remote</paper-item>
    <paper-item file="channels.html"><iron-icon icon="apps"></iron-icon>Channels</paper-item>
    <paper-item file="recordings.html">Recordings</paper-item>
    <paper-item>Play URL</paper-item>
   </paper-menu>
   <paper-progress max="100" class="green" indeterminate></paper-progress>
  </paper-material>
  <paper-header-panel id="main" mode="standard" main>
   <paper-toolbar mode="none">
     <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
     <span id="gui-title-bar" class="title">EE TV : CONNECTING</span>
     <paper-icon-button icon="refresh"></paper-icon-button>
   </paper-toolbar>
   <neon-animated-pages selected="0" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation">
    <neon-animatable page="remote.html"></neon-animatable>
    <neon-animatable page="channels.html"></neon-animatable>
    <neon-animatable page="recordings.html"></neon-animatable>
   </neon-animated-pages>
  </paper-header-panel>
 </paper-drawer-panel>
 <paper-material id="drawer-fake" elevation="5">
  **FAKE DRAWER : DO NOT USE**
 </paper-material>
 <paper-dialog id="connect" entry-animation="scale-up-animation" exit-animation="fade-out-animation" modal>
  <table class="holder" style="min-width:240px;"><tr><th colspan="100" nowrap>CONNECT ON IP</th></tr><tr>
   <td><paper-input type="tel" size="3" maxlength="3" label="192" pattern="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$" no-label-float auto-validate></paper-input></td>
   <td style="font-size:30px;">.</td>
   <td><paper-input type="tel" size="3" maxlength="3" label="168" pattern="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$" no-label-float auto-validate></paper-input></td>
   <td style="font-size:30px;">.</td>
   <td><paper-input type="tel" size="3" maxlength="3" label="1" pattern="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$" no-label-float auto-validate></paper-input></td>
   <td style="font-size:30px;">.</td>
   <td><paper-input type="tel" size="3" maxlength="3" label="1" pattern="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])$" no-label-float auto-validate></paper-input></td>
  </tr></table>
  <div class="buttons">
   <paper-button autofocus>CONNECT</paper-button>
  </div>
 </paper-dialog>
</template>
<script type="text/javascript">
var unix=parseInt(new Date().getTime()),start=1;
var urls=function(key){return scheme+host+paths[key];};
var scheme="http://",host="192.168.1.1",tv_data="",paths={"":"",
 "recordings":"/PVR/Records/getList?type=regular&avoidHD=0&tvOnly=0",
 "remote_keys":"/RemoteControl/KeyHandling/sendKey?avoidLongPress=1&key=",
 "channels":"/Live/Channels/getList?tvOnly=0&avoidHD=0&allowHidden=0&fields=name,id,zap,isDVB,hidden,rank,isHD,logo",
 "play_video":"/Live/External/play?position=0&url=", //PLAYS FROM INTERNET ON TV
 "play_recording":"/PVR/Records/play?recordId=", //PLAYS FROM PVR ON TV
 "get_download_session_id":"/PVR/Records/session?recordId=",
 "download_file_by_session_id":"/PVR/Records/getVideo?sessionId=",
 "find_programme":"/EPG/Programs/find?fieldName=name&fieldValue=", // &zap=
 "channel_logos":"/Live/Channels/getLogo?zap=",
 "cancel_timer":"/EPG/Timers/delete?timerId=",
 "timers":"/EPG/Timers/getConfig",
 "zap":"/Live/Channels/zap?zap=", //CHANGE TV CHANNEL
 "info":"/UPnP/Device/getInfo"
};
 
$(document).on("ready",function(){
 if($.cookie("host")){host=$.cookie("host");}
 $("#mainContainer").removeClass("style-scope");
 $(document).ajaxStart(function(){$("[icon='refresh']").addClass("spin");});
 $(document).ajaxStop(function(){$("[icon='refresh']").removeClass("spin");});
 var inputs=document.querySelector("#connect").querySelectorAll("paper-input");

 var menu=document.querySelector("paper-drawer-panel");
  menu.closeDrawer=function(){$("paper-toast-stack").animate({"left":"12px"});this.selected="main";};
  menu.openDrawer=function(){$("paper-toast-stack").animate({"left":"268px"});this.selected="drawer";};

 $("paper-item:contains('URL')").on("click",function(page){
  var link="http://www.quirksmode.org/html5/videos/big_buck_bunny.mp4";
  var pushlink=encodeURIComponent(prompt("Enter URL You Want To Watch",link));
  if(pushlink.match("http")){$.get(urls("play_video")+pushlink);}
  document.querySelector("paper-drawer-panel").closeDrawer();
 });

 $("paper-button:contains('CONNECT')").on("click",function(event){
  var t=[];$(inputs).each(function(k,v){t[k]=v.value?v.value:v.label;});host=t.join(".");
  var powerOn="http://"+host+"/RemoteControl/KeyHandling/sendKey?avoidLongPress=1&key=on_off";
  $.getJSON("http://"+host+"/UPnP/Device/getInfo?nc="+parseInt(new Date().getTime()),function(info_data){
   if(!info_data.pvr.available){$.get(powerOn,function(){$().sleep(5000,function(){$(window).trigger("connected");});});}
   if(info_data.pvr.available){tv_data=info_data;$(window).trigger("connected");}
  }).error(function(e){$().toast({text:"FAILED TO CONNECT TO "+host,type:"alert"});});
 });
  
 $("[icon='refresh']").on("click",function(){
  var pageHandle=$("neon-animatable[class='iron-selected']");
  $.get(pageHandle.attr("page")+"?nc="+new Date().getTime(),function(d){
   console.log("RELOADED",$(this)[0].url);
   $(pageHandle).html(d);
  }); 
 });
  
 $(window).on("load",function(){
  document.querySelector("paper-menu").selected=page;
  document.querySelector("neon-animated-pages").selected=start;
  $(host.split(".")).each(function(k,v){inputs[k].label=v});
  document.querySelector("#connect").open();
 });

 $(window).on("connected",function(e,data){
  var used=parseInt(tv_data.pvr.status.disk.usedSpace/1024/1024);
		var total=parseInt(tv_data.pvr.status.disk.totalSpace/1024/1024);
  $(window).toast({text:"CONNECT TO "+host}).trigger("display",start);
  $("paper-item[file]").on("click",function(){$(window).trigger("display",$(this).index())});
  $("neon-animatable").each(function(k,v){$.get($(this).attr("page"),function(d){$(v).html(d);})});
  $("paper-progress").attr("value",tv_data.pvr.status.disk.percent).removeAttr("indeterminate");
  $("paper-progress").append("<span><b>"+used+"GB</b> of <b>"+total+"GB</b></span>");
  $("paper-progress").append("<code>Connected via: "+host+"</code>");
  $.cookie("host",host,{expires:7});console.clear();
 });
 
 $(window).on("display",function(e,page){
  var pageHandle=document.querySelector("neon-animated-pages");
  var pageName=document.querySelectorAll("paper-item")[page].innerHTML;
   if(page==0){$("[icon='refresh']").hide();}else{$("[icon='refresh']").show();}
   pageHandle.entryAnimation="slide-from-"+(page<pageHandle.selected?"left":"right")+"-animation";
   pageHandle.exitAnimation="slide-"+(page<pageHandle.selected?"right":"left")+"-animation";
  document.querySelector("#gui-title-bar").innerHTML="EE TV : "+pageName.toUpperCase();
  document.querySelector("paper-drawer-panel").closeDrawer();
  document.querySelector("paper-menu").selected=page;
  document.querySelector("#connect").close();
  pageHandle.selected=page;
 });
});
</script>
</body>
</html>
